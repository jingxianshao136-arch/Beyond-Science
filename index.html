<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>Gemini Pro 3D AI 塔罗占卜系统</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/0.160.0/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/hands/hands.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.2/gsap.min.js"></script>
    <style>
        :root { --gold: #d4af37; --purple: #1a0a2e; }
        body { margin: 0; overflow: hidden; background: radial-gradient(circle, #1a0a2e 0%, #05020a 100%); font-family: 'Microsoft YaHei', serif; }
        #ui-overlay { position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 100; color: var(--gold); }
        .panel { pointer-events: auto; background: rgba(0,0,0,0.7); border: 1px solid var(--gold); padding: 15px; border-radius: 8px; backdrop-filter: blur(10px); }
        #controls { position: absolute; top: 20px; left: 20px; width: 200px; }
        #status-bar { position: absolute; top: 20px; left: 50%; transform: translateX(-50%); text-align: center; width: 400px; font-size: 18px; text-shadow: 0 0 10px var(--gold); }
        #history { position: absolute; top: 20px; right: 20px; width: 240px; max-height: 80vh; overflow-y: auto; }
        #video-preview { position: absolute; bottom: 20px; right: 20px; width: 200px; height: 150px; border: 2px solid var(--gold); transform: scaleX(-1); border-radius: 10px; }
        button { background: transparent; color: var(--gold); border: 1px solid var(--gold); width: 100%; padding: 8px; margin: 5px 0; cursor: pointer; transition: 0.3s; }
        button:hover { background: var(--gold); color: black; }
        .card-log { font-size: 12px; margin-bottom: 5px; border-bottom: 1px solid #333; padding-bottom: 5px; }
    </style>
</head>
<body>

    <div id="ui-overlay">
        <div id="status-bar">正在加载 78 张神秘塔罗...</div>
        
        <div id="controls" class="panel">
            <h3 style="margin-top:0">选择牌阵</h3>
            <button onclick="initGame('single')">单张启示 (1张)</button>
            <button onclick="initGame('three')">圣三角 (3张)</button>
            <button onclick="initGame('cross')">十字恋人 (5张)</button>
            <hr border="0" style="border-top:1px solid #444">
            <button onclick="shuffleDeck()" style="border-color:#ff6b6b; color:#ff6b6b;">重新洗牌</button>
        </div>

        <div id="history" class="panel">
            <div style="font-weight:bold; margin-bottom:10px;">占卜之书</div>
            <div id="log-content"></div>
        </div>
    </div>

    <div id="video-preview">
        <video id="input_video" style="display:none"></video>
        <canvas class="output_canvas" style="width:100%; height:100%"></canvas>
    </div>

<script>
/**
 * 1. 完善的 78 张牌库配置
 */
const CARD_DATA = [];
const SUITS = ['cups', 'pentacles', 'swords', 'wands'];
const FACES = ['01','02','03','04','05','06','07','08','09','10','page','knight','queen','king'];

// 大阿卡纳 (22张)
const MajorNames = ['Fool','Magician','Priestess','Empress','Emperor','Hierophant','Lovers','Chariot','Strength','Hermit','Wheel','Justice','HangedMan','Death','Temperance','Devil','Tower','Star','Moon','Sun','Judgement','World'];
MajorNames.forEach((name, i) => {
    let id = i.toString().padStart(2, '0');
    CARD_DATA.push({ id: `ar${id}`, name: `[大阿卡纳] ${name}`, url: `https://raw.githubusercontent.com/the-prodigal-son/tarot-api/master/static/cards/ar${id}.jpg` });
});
// 小阿卡纳 (56张)
SUITS.forEach(suit => {
    FACES.forEach(face => {
        let code = suit[0] + face;
        CARD_DATA.push({ id: code, name: `${face} of ${suit}`, url: `https://raw.githubusercontent.com/the-prodigal-son/tarot-api/master/static/cards/${code}.jpg` });
    });
});

/**
 * 2. 初始化 3D 引擎
 */
const scene = new THREE.Scene();
const camera = new THREE.PerspectiveCamera(50, window.innerWidth/window.innerHeight, 0.1, 1000);
const renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
renderer.setSize(window.innerWidth, window.innerHeight);
document.body.appendChild(renderer.domElement);

const ambient = new THREE.AmbientLight(0xffffff, 0.5);
const point = new THREE.PointLight(0xffd700, 2, 50);
point.position.set(0, 5, 5);
scene.add(ambient, point);
camera.position.set(0, 2, 10);

let deckPool = [];
let drawnCards = [];
let visualDeck = []; // 用于洗牌特效的物体
let currentSpread = 'single';
let maxDraw = 1;

const loader = new THREE.TextureLoader();
const backTex = loader.load('https://upload.wikimedia.org/wikipedia/commons/5/54/Tarot_Back.jpg');

/**
 * 3. 牌阵坐标映射
 */
const SPREAD_CONFIGS = {
    'single': [{x:0, y:0, z:0, label: "启示"}],
    'three': [
        {x:-3, y:0, z:0, label: "过去"},
        {x:0, y:0, z:0, label: "现在"},
        {x:3, y:0, z:0, label: "未来"}
    ],
    'cross': [
        {x:0, y:0, z:0, label: "现状"},
        {x:0, y:0.2, z:0